import os
import json
import qrcode
import sqlite3
import uuid
import subprocess
from io import BytesIO
from datetime import datetime, timedelta
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import (
    ApplicationBuilder, CommandHandler, CallbackQueryHandler,
    ContextTypes
)

# === Load env ===
load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_IDS = [int(x) for x in os.getenv("ADMIN_IDS", "").split(",") if x]

SERVER_ADDR = os.getenv("SERVER_ADDR")
SERVER_PORT = os.getenv("SERVER_PORT", "443")
REALITY_SNI = os.getenv("REALITY_SNI")
REALITY_PBK = os.getenv("REALITY_PBK")
REALITY_SID = os.getenv("REALITY_SID")
FLOW = os.getenv("FLOW", "")
FP = os.getenv("FP", "")
LABEL = os.getenv("LABEL", "CloudNetVPN")

CONFIG_PATH = os.getenv("CONFIG_PATH", "/root/bot/config.json")
DB_PATH = os.getenv("DB_PATH", "single_bot.db")

PAYMENT_LINK = os.getenv("PAYMENT_LINK", "https://plisio.net/donate/tTnwF4nV")
PAYPAL_EMAIL = os.getenv("PAYPAL_EMAIL", "your@mail.com")
SUPPORT_CONTACT = os.getenv("SUPPORT_CONTACT", "@CloudNetVIP_support")

# === DB ===
conn = sqlite3.connect(DB_PATH, check_same_thread=False)
c = conn.cursor()
c.execute("""CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER,
    uuid TEXT,
    expire_at TEXT
)""")
conn.commit()

# === Texts ===
TEXT = {
    "menu": {
        "en": "Main menu:",
        "ru": "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:"
    },
    "buy": {
        "en": "üí≥ Buy Subscription\n\nPay here:\nCrypto: {}\nPayPal: {}",
        "ru": "üí≥ –ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É\n\n–û–ø–ª–∞—Ç–∏—Ç–µ –∑–¥–µ—Å—å:\n–ö—Ä–∏–ø—Ç–æ: {}\nPayPal: {}"
    },
    "check_empty": {
        "en": "‚ùå No active subscription.",
        "ru": "‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."
    },
    "support": {
        "en": "üì© Write to {} for support.",
        "ru": "üì© –ù–∞–ø–∏—à–∏—Ç–µ {} –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏."
    },
    "added": {
        "en": "‚úÖ User {} added for {} days.",
        "ru": "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {} –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ {} –¥–Ω–µ–π."
    },
    "extended": {
        "en": "üîÑ User {} extended for {} more days.",
        "ru": "üîÑ –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {} –ø—Ä–æ–¥–ª–µ–Ω–∞ –Ω–∞ {} –¥–Ω–µ–π."
    },
    "expired": {
        "en": "‚è≥ Subscription expired. User {} removed.",
        "ru": "‚è≥ –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {} —É–¥–∞–ª—ë–Ω."
    }
}

def main_menu(lang="en"):
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üí≥ Buy Subscription", callback_data=f"buy_{lang}")],
        [InlineKeyboardButton("üîë Check Subscription", callback_data=f"check_{lang}")],
        [InlineKeyboardButton("üì© Support", callback_data=f"support_{lang}")]
    ])

def back_button(lang="en"):
    return InlineKeyboardMarkup([[InlineKeyboardButton("üîô Back", callback_data=f"back_{lang}")]])

# === Helpers ===
def generate_vless_link(user_uuid: str):
    return f"vless://{user_uuid}@{SERVER_ADDR}:{SERVER_PORT}?encryption=none&security=reality&sni={REALITY_SNI}&fp={FP}&pbk={REALITY_PBK}&sid={REALITY_SID}&flow={FLOW}#{LABEL}"

def generate_qr(vless_link: str):
    qr = qrcode.make(vless_link)
    bio = BytesIO()
    qr.save(bio, format="PNG")
    bio.seek(0)
    return bio

def upsert_in_config(user_uuid):
    with open(CONFIG_PATH, "r") as f:
        config = json.load(f)

    clients = config["inbounds"][0]["settings"].get("clients", [])
    clients = [cl for cl in clients if cl["id"] != user_uuid]
    clients.append({
        "id": user_uuid,
        "email": f"user-{user_uuid}@vpn.local",
        "flow": FLOW
    })
    config["inbounds"][0]["settings"]["clients"] = clients

    with open(CONFIG_PATH, "w") as f:
        json.dump(config, f, indent=2)

    subprocess.run(["systemctl", "restart", "xray"])

def remove_from_config(user_uuid):
    with open(CONFIG_PATH, "r") as f:
        config = json.load(f)

    clients = config["inbounds"][0]["settings"].get("clients", [])
    clients = [cl for cl in clients if cl["id"] != user_uuid]
    config["inbounds"][0]["settings"]["clients"] = clients

    with open(CONFIG_PATH, "w") as f:
        json.dump(config, f, indent=2)

    subprocess.run(["systemctl", "restart", "xray"])

def cleanup_subs(context: ContextTypes.DEFAULT_TYPE):
    now = datetime.utcnow()
    c.execute("SELECT user_id, uuid, expire_at FROM users")
    for user_id, u, exp in c.fetchall():
        if datetime.fromisoformat(exp) < now:
            c.execute("DELETE FROM users WHERE uuid=?", (u,))
            conn.commit()
            remove_from_config(u)
            for admin in ADMIN_IDS:
                context.bot.send_message(admin, TEXT["expired"]["en"].format(user_id))

# === Handlers ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(TEXT["menu"]["en"], reply_markup=main_menu("en"))

async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    action, lang = query.data.split("_")

    if action == "buy":
        await query.edit_message_text(TEXT["buy"][lang].format(PAYMENT_LINK, PAYPAL_EMAIL),
                                      reply_markup=back_button(lang))
    elif action == "check":
        c.execute("SELECT uuid, expire_at FROM users WHERE user_id=?", (query.from_user.id,))
        row = c.fetchone()
        if not row:
            await query.edit_message_text(TEXT["check_empty"][lang], reply_markup=back_button(lang))
            return
        user_uuid, expire_at = row
        vless_link = generate_vless_link(user_uuid)
        qr = generate_qr(vless_link)
        await context.bot.send_photo(chat_id=query.from_user.id, photo=qr,
                                     caption=f"üîë Config:\n`{vless_link}`\n\nExpires: {expire_at}",
                                     parse_mode="Markdown",
                                     reply_markup=back_button(lang))
    elif action == "support":
        await query.edit_message_text(TEXT["support"][lang].format(SUPPORT_CONTACT),
                                      reply_markup=back_button(lang))
    elif action == "back":
        # –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –º–µ–Ω—é, –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ
        await context.bot.send_message(chat_id=query.from_user.id,
                                       text=TEXT["menu"][lang],
                                       reply_markup=main_menu(lang))

async def add(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMIN_IDS:
        return
    if len(context.args) < 2:
        await update.message.reply_text("Usage: /add user_id days")
        return

    user_id, days = int(context.args[0]), int(context.args[1])
    c.execute("SELECT uuid, expire_at FROM users WHERE user_id=?", (user_id,))
    row = c.fetchone()

    if row:
        user_uuid, expire_at = row
        new_exp = max(datetime.fromisoformat(expire_at), datetime.utcnow()) + timedelta(days=days)
        c.execute("UPDATE users SET expire_at=? WHERE user_id=?", (new_exp.isoformat(), user_id))
        conn.commit()
        upsert_in_config(user_uuid)
        vless_link = generate_vless_link(user_uuid)
        qr = generate_qr(vless_link)
        await update.message.reply_text(TEXT["extended"]["en"].format(user_id, days))
        try:
            await context.bot.send_photo(chat_id=user_id, photo=qr,
                                         caption=f"üîë Config:\n`{vless_link}`\n\nExpires: {new_exp.date()}",
                                         parse_mode="Markdown",
                                         reply_markup=back_button("en"))
        except:
            await update.message.reply_text("‚ö†Ô∏è Failed to resend config to user.")
    else:
        user_uuid = str(uuid.uuid4())
        expire_at = datetime.utcnow() + timedelta(days=days)
        c.execute("INSERT INTO users (user_id, uuid, expire_at) VALUES (?, ?, ?)",
                  (user_id, user_uuid, expire_at.isoformat()))
        conn.commit()
        upsert_in_config(user_uuid)
        vless_link = generate_vless_link(user_uuid)
        qr = generate_qr(vless_link)
        await update.message.reply_text(TEXT["added"]["en"].format(user_id, days))
        try:
            await context.bot.send_photo(chat_id=user_id, photo=qr,
                                         caption=f"üîë Config:\n`{vless_link}`\n\nExpires: {expire_at.date()}",
                                         parse_mode="Markdown",
                                         reply_markup=back_button("en"))
        except:
            await update.message.reply_text("‚ö†Ô∏è Failed to send config to user.")

# === Main ===
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("add", add))
    app.add_handler(CallbackQueryHandler(button))

    app.job_queue.run_repeating(cleanup_subs, interval=3600, first=10)

    app.run_polling()

if __name__ == "__main__":
    main()
